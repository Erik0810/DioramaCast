name: Test DioramaCast Application

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
    
    env:
      OPENWEATHER_API_KEY: ${{ secrets.OPENWEATHER_API_KEY }}
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      FLASK_DEBUG: False
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-flask
    
    - name: Run application tests
      run: |
        python -m pytest tests/ -v || echo "No tests directory found, running basic smoke test"
        python -c "from app import app; print('âœ… Flask app imports successfully')"
    
    - name: List available Gemini models
      run: |
        python << EOF
        import os
        from google import genai
        
        api_key = os.environ.get('GEMINI_API_KEY', '')
        
        if not api_key:
            print("âš ï¸ GEMINI_API_KEY not set, skipping model listing")
        else:
            try:
                client = genai.Client(api_key=api_key)
                print("ðŸ“‹ Available Gemini Models:")
                print("=" * 60)
                
                # List all models
                models = client.models.list()
                
                # Filter and display image generation models
                image_models = []
                text_models = []
                
                for model in models:
                    model_name = model.name
                    # Check if it's an image generation model
                    if 'imagen' in model_name.lower() or 'image' in model_name.lower():
                        image_models.append(model_name)
                    else:
                        text_models.append(model_name)
                
                if image_models:
                    print("\nðŸ–¼ï¸  IMAGE GENERATION MODELS:")
                    for model in image_models:
                        print(f"  - {model}")
                else:
                    print("\nâš ï¸  No specific image generation models found")
                
                if text_models:
                    print("\nðŸ’¬ TEXT GENERATION MODELS (first 10):")
                    for model in text_models[:10]:
                        print(f"  - {model}")
                
                print("\n" + "=" * 60)
                print(f"Total models available: {len(list(models))}")
                
            except Exception as e:
                print(f"âŒ Error listing models: {e}")
                print(f"Error type: {type(e).__name__}")
        EOF
    
    - name: Test API endpoints
      run: |
        python app.py &
        APP_PID=$!
        sleep 5
        
        # Test main page
        curl -f http://localhost:5000/ || exit 1
        echo "âœ… Main page loads"
        
        # Test weather API (will return error if no API key, but should not crash)
        curl -f "http://localhost:5000/api/weather?lat=40.7128&lon=-74.0060" || echo "âš ï¸ Weather API needs key"
        
        # Test image generation API
        curl -f -X POST http://localhost:5000/api/generate-image \
          -H "Content-Type: application/json" \
          -d '{"location":"TestCity","weather":"clear","temperature":20,"settings":{}}' || exit 1
        echo "âœ… Image generation endpoint works"
        
        kill $APP_PID
    
    - name: Verify environment variables
      run: |
        python << EOF
        import os
        
        weather_key = os.environ.get('OPENWEATHER_API_KEY', '')
        image_key = os.environ.get('GEMINI_API_KEY', '')
        
        print("Environment Variables Status:")
        print(f"âœ… OPENWEATHER_API_KEY: {'configured' if weather_key else 'not set'}")
        print(f"âœ… GEMINI_API_KEY: {'configured' if image_key else 'not set'}")
        print(f"âœ… FLASK_DEBUG: {os.environ.get('FLASK_DEBUG', 'not set')}")
        
        if weather_key:
            print(f"   Weather API key length: {len(weather_key)} characters")
        if image_key:
            print(f"   Image API key length: {len(image_key)} characters")
        EOF
